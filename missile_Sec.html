<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>미사일 피하기 게임</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <style>
    html, body { height: 100%; margin:0; }
    body { background: #333; margin:0; position:relative; height:100vh; }
    #game-container { position:relative; width:100vw; max-width:600px; margin:40px auto 0; }
    canvas { background: #fff; display: block; width: 100%; height: auto; border-radius: 16px; }
    #result {
      position: absolute;
      left: 50%; top: 35%;
      transform: translate(-50%, -50%);
      font-size: 44px;
      color: #d32f2f;
      font-family: 'Consolas', 'Arial';
      font-weight: bold;
      background: rgba(255,255,255,0.85);
      padding: 18px 40px 8px 40px;
      border-radius: 18px;
      display: none;
      z-index: 2;
      text-align: center;
      box-shadow: 0 2px 16px rgba(0,0,0,0.15);
      min-width: 280px;
      pointer-events:none;
    }
    #restart {
      position: absolute;
      left: 50%; top: 60%;
      transform: translate(-50%, -50%);
      font-size: 22px;
      color: #555;
      font-family: 'Consolas', 'Arial';
      background: rgba(255,255,255,0.95);
      padding: 16px 30px;
      border-radius: 16px;
      display: none;
      z-index: 3;
      text-align: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.10);
      cursor:pointer;
    }
    #joystick {
      position: absolute;
      left: 30px; bottom: 40px;
      width: 96px; height: 96px;
      z-index: 10;
      display: none;
      opacity: 0.93;
      user-select: none;
    }
    .joystick-bg {
      position: absolute; left:0; top:0;
      width: 96px; height: 96px;
      border-radius: 50%;
      background: #ddd;
      opacity:0.45;
    }
    .joystick-knob {
      position: absolute; left:36px; top:36px;
      width: 24px; height:24px;
      background:#1976d2;
      border-radius: 50%;
      box-shadow: 0 2px 6px #2223;
      touch-action: none;
    }
    @media (max-width:700px) {
      #game-container { max-width: 100vw; }
      #joystick { left:12px; bottom:18px; }
    }
  </style>
</head>
<body>
  <div id="game-container">
    <canvas id="game" width="600" height="400"></canvas>
    <div id="result"></div>
    <div id="restart">스페이스바 또는 터치해서<br>재시작하세요.</div>
    <div id="joystick">
      <div class="joystick-bg"></div>
      <div class="joystick-knob"></div>
    </div>
  </div>
  <script>
    // 캔버스/컨텍스트
    const container = document.getElementById('game-container');
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');
    const resultDiv = document.getElementById('result');
    const restartDiv = document.getElementById('restart');
    const joystick = document.getElementById('joystick');
    const knob = joystick.querySelector('.joystick-knob');
    let startTime, survivedSec = 0;
    let gameOver = false;
    let joystickActive = false;
    let knobX = 0, knobY = 0;

    // 반응형 리사이즈
    function resizeCanvas() {
      const width = container.offsetWidth;
      canvas.width = width;
      canvas.height = width * 2 / 3;
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    // 플레이어(공) 정보
    const player = {
      x: canvas.width / 2,
      y: canvas.height / 2,
      r: 18,
      color: '#1976d2',
      speed: 4
    };

    // 키 입력 (방향키 눌러도 스크롤X)
    const keys = {ArrowLeft: false, ArrowRight: false, ArrowUp: false, ArrowDown: false};
    document.addEventListener('keydown', e => { 
      if(e.key in keys) {
        keys[e.key] = true;
        e.preventDefault(); // 스크롤 방지
      }
    });
    document.addEventListener('keyup', e => { 
      if(e.key in keys) {
        keys[e.key] = false;
        e.preventDefault(); // 스크롤 방지
      }
    });

    // 터치용 방향 처리
    function setJoystickDirection(dx, dy) {
      keys.ArrowLeft  = dx < -0.4;
      keys.ArrowRight = dx >  0.4;
      keys.ArrowUp    = dy < -0.4;
      keys.ArrowDown  = dy >  0.4;
    }
    function resetJoystick() {
      keys.ArrowLeft = keys.ArrowRight = keys.ArrowUp = keys.ArrowDown = false;
      knob.style.left = "36px";
      knob.style.top = "36px";
    }

    // 모바일/터치 감지
    function isMobile() {
      return /Android|iPhone|iPad|iPod|Mobile/i.test(navigator.userAgent);
    }
    if(isMobile()) {
      joystick.style.display = "block";
    }

    // 조이스틱 이벤트
    let baseX=0, baseY=0;
    function joystickStart(ev) {
      joystickActive = true;
      const touch = ev.touches ? ev.touches[0] : ev;
      const rect = joystick.getBoundingClientRect();
      baseX = rect.left + rect.width/2;
      baseY = rect.top + rect.height/2;
      document.addEventListener('mousemove', joystickMove);
      document.addEventListener('touchmove', joystickMove, {passive:false});
      document.addEventListener('mouseup', joystickEnd);
      document.addEventListener('touchend', joystickEnd);
      joystickMove(ev);
    }
    function joystickMove(ev) {
      if (!joystickActive) return;
      let clientX, clientY;
      if(ev.touches) {
        clientX = ev.touches[0].clientX;
        clientY = ev.touches[0].clientY;
      } else {
        clientX = ev.clientX;
        clientY = ev.clientY;
      }
      let dx = clientX - baseX;
      let dy = clientY - baseY;
      let dist = Math.sqrt(dx*dx + dy*dy);
      if(dist > 36) {
        dx = dx * 36 / dist;
        dy = dy * 36 / dist;
        dist = 36;
      }
      knob.style.left = (36 + dx) + "px";
      knob.style.top = (36 + dy) + "px";
      setJoystickDirection(dx/36, dy/36);
      if(ev.cancelable) ev.preventDefault();
    }
    function joystickEnd() {
      joystickActive = false;
      resetJoystick();
      document.removeEventListener('mousemove', joystickMove);
      document.removeEventListener('touchmove', joystickMove);
      document.removeEventListener('mouseup', joystickEnd);
      document.removeEventListener('touchend', joystickEnd);
    }
    knob.addEventListener('mousedown', joystickStart);
    knob.addEventListener('touchstart', joystickStart, {passive:false});

    // 미사일 설정
    const missiles = [];
    function spawnMissile() {
      const edge = Math.floor(Math.random() * 4);
      let x, y, dx, dy;
      const missileSpeed = 2.7 + Math.random() * 1.4;
      const mSize = 12 + Math.random() * 8;
      if (edge === 0) { x = Math.random() * canvas.width; y = 0; }
      else if (edge === 1) { x = Math.random() * canvas.width; y = canvas.height; }
      else if (edge === 2) { x = 0; y = Math.random() * canvas.height; }
      else { x = canvas.width; y = Math.random() * canvas.height; }
      const angle = Math.atan2(player.y - y, player.x - x);
      dx = Math.cos(angle) * missileSpeed;
      dy = Math.sin(angle) * missileSpeed;
      missiles.push({ x, y, dx, dy, r: mSize, color: '#f44336' });
    }

    let missileInterval = 900;
    let lastMissileTime = 0;

    function checkCollision(a, b) {
      const dist = Math.hypot(a.x - b.x, a.y - b.y);
      return dist < (a.r + b.r);
    }

    function startGame() {
      player.x = canvas.width / 2;
      player.y = canvas.height / 2;
      missiles.length = 0;
      gameOver = false;
      startTime = Date.now();
      survivedSec = 0;
      resultDiv.style.display = 'none';
      restartDiv.style.display = 'none';
      missileInterval = 900;
      Object.keys(keys).forEach(k => keys[k] = false);
      resetJoystick();
      requestAnimationFrame(gameLoop);
    }

    function gameLoop() {
      if (!gameOver) {
        survivedSec = (Date.now() - startTime) / 1000;
      }
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // 플레이어 이동
      if (keys.ArrowLeft && player.x - player.r > 0) player.x -= player.speed;
      if (keys.ArrowRight && player.x + player.r < canvas.width) player.x += player.speed;
      if (keys.ArrowUp && player.y - player.r > 0) player.y -= player.speed;
      if (keys.ArrowDown && player.y + player.r < canvas.height) player.y += player.speed;

      // 플레이어 그리기
      ctx.beginPath();
      ctx.arc(player.x, player.y, player.r, 0, Math.PI * 2);
      ctx.fillStyle = player.color;
      ctx.shadowColor = '#90caf9';
      ctx.shadowBlur = 10;
      ctx.fill();
      ctx.closePath();
      ctx.shadowBlur = 0;

      // 미사일 그리기 및 이동
      for (let i = missiles.length - 1; i >= 0; i--) {
        const m = missiles[i];
        m.x += m.dx;
        m.y += m.dy;
        ctx.beginPath();
        ctx.arc(m.x, m.y, m.r, 0, Math.PI * 2);
        ctx.fillStyle = m.color;
        ctx.fill();
        ctx.closePath();

        if (checkCollision(player, m)) {
          gameOver = true;
        }
        if (
          m.x < -40 || m.x > canvas.width + 40 ||
          m.y < -40 || m.y > canvas.height + 40
        ) {
          missiles.splice(i, 1);
        }
      }

      // 미사일 추가 (점점 빨라짐)
      const now = Date.now();
      if (now - lastMissileTime > missileInterval && !gameOver) {
        spawnMissile();
        lastMissileTime = now;
        if (missileInterval > 450) missileInterval -= 8;
      }

      // 생존 시간 표시
      ctx.save();
      ctx.font = "bold " + Math.round(canvas.width/30) + "px Consolas, Arial";
      ctx.fillStyle = "#1976d2";
      ctx.textAlign = "right";
      ctx.fillText(survivedSec.toFixed(1) + " Sec", canvas.width - 18, 32);
      ctx.restore();

      // 게임 오버 처리
      if (gameOver) {
        resultDiv.textContent = survivedSec.toFixed(1) + ' Sec';
        resultDiv.style.display = 'block';
        restartDiv.style.display = 'block';
        joystick.style.opacity = 0.35;

        // 스페이스바 또는 터치로 재시작
        document.onkeydown = function(e) {
          if (e.code === "Space") {
            document.onkeydown = null;
            restartDiv.style.display = 'none';
            joystick.style.opacity = 0.93;
            startGame();
          }
        };
        restartDiv.onclick = function() {
          restartDiv.style.display = 'none';
          joystick.style.opacity = 0.93;
          document.onkeydown = null;
          startGame();
        };
        return;
      }
      joystick.style.opacity = 0.93;
      requestAnimationFrame(gameLoop);
    }

    // 최초 시작
    resultDiv.textContent = '';
    restartDiv.style.display = 'block';
    resultDiv.style.display = 'none';
    restartDiv.innerHTML = '스페이스바 또는 터치해서<br>시작하세요.';

    document.onkeydown = function(e) {
      if (e.code === "Space") {
        document.onkeydown = null;
        restartDiv.style.display = 'none';
        startGame();
      }
    };
    restartDiv.onclick = function() {
      restartDiv.style.display = 'none';
      document.onkeydown = null;
      startGame();
    };

    // 처음 모바일이면 조이스틱 표시
    if(isMobile()) joystick.style.display = "block";
  </script>
</body>
</html>
